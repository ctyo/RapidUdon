<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="">
    <link rel="shortcut icon" href="">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.52.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id='map' style='width: 100%; height: 100%;'></div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3R5byIsImEiOiJjanF2cTNjMm8weHVjNDJrOGV2anp3NDFwIn0.4pGtZ9Run1--9FR8NBkuqg';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v9',
            center: [134.0079852, 34.2301713],
            zoom: 9
        });

        var udon = {};
        var start, goal = {}
        map.on('load', function () {
            fetch('udon.json')
                .then(function (res) {
                    return res.json();
                }).then(function (json) {
                    udon = json;
                    map.addLayer({
                        "id": "points",
                        "type": "symbol",
                        "source": {
                            "type": "geojson",
                            "data": json
                        },
                        "layout": {
                            "icon-image": "restaurant-15",
                            /*
                            "text-field": "{title}",
                            "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
                            "text-offset": [0, 0.6],
                            "text-anchor": "top",
                            'text-size': 11
                            */
                        }
                    });

                    start = new mapboxgl.Marker({
                        draggable: true
                    }).setLngLat([134.0412469, 34.3493544]).addTo(map);

                    goal = new mapboxgl.Marker({
                        draggable: true
                    }).setLngLat([134.0078172, 34.2143716]).addTo(map);
                    //                    start.on('dragend', onDragEnd);
                });
        });

        map.on('click', 'points', function (point) {
            var html = '<a target="_blank" href="' + point.features[0].properties.link + '">' + point.features[0].properties.title + '</a>'
            new mapboxgl.Popup()
                .setLngLat(point.lngLat)
                .setHTML(html)
                .addTo(map);
        });

        // startとgoalのピンを置く
        // urlに位置は反映させる
        // startとgoalに仮で直線を引く
        // 閾値(1km程度)内に一番近いポイントで二分割する
        // ポイントとstart, goalに仮で直線を引く....
        // これを残りポイントがなくなるまで実施する
        // リスト化してpolylineを描画する

        function get_near_udon_list(_start, _goal) {
            var dist_limit = 1000 / 1000;

            var point = get_nearest_point(_start, _goal);
            if (point === false) {
                return;
            }
            var point_marker = new mapboxgl.Marker().setLngLat(point.geometry.coordinates).addTo(map);

            var s_p_dist = turf.distance(
                turf.point([start.getLngLat().lng, start.getLngLat().lat]),
                turf.point(point.geometry.coordinates)
            );
            if (s_p_dist < dist_limit) {
                get_near_udon_list(_start, point_marker);
            }


            var p_g_dist = turf.distance(
                turf.point(point.geometry.coordinates),
                turf.point([goal.getLngLat().lng, goal.getLngLat().lat]),
            );
            if (p_g_dist > dist_limit) {
                get_near_udon_list(point_marker, _goal);
            }

        }

        var already_draw = [];
        function get_nearest_point(s, g) {
            // global udon
            var min = 999999;
            var ret = null;
            for (var i = 0; i < udon.features.length; i++) {
                dist = min_d2(udon.features[i].geometry.coordinates[0],
                    udon.features[i].geometry.coordinates[1],
                    s.getLngLat().lng, s.getLngLat().lat,
                    g.getLngLat().lng, g.getLngLat().lat);
                if (dist < min && !already_draw.includes(udon.features[i].properties.link)) {
                    min = dist
                    ret = i;
                }
            }
            if (ret === null) { return false }
            already_draw.push(udon.features[ret].properties.link)
            return udon.features[ret];
        }

        function min_d2(x0, y0, x1, y1, x2, y2) {
            var a = x2 - x1;
            var b = y2 - y1;
            var a2 = a * a;
            var b2 = b * b;
            var r2 = a2 + b2;
            var tt = -(a * (x1 - x0) + b * (y1 - y0));
            if (tt < 0) {
                return (x1 - x0) * (x1 - x0) + (y1 - y0) * (y1 - y0);
            }
            if (tt > r2) {
                return (x2 - x0) * (x2 - x0) + (y2 - y0) * (y2 - y0);
            }
            var f1 = a * (y1 - y0) - b * (x1 - x0);
            return (f1 * f1) / r2;
        }


    </script>

</body>

</html>